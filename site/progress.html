<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Lab Progress</title>

    <link rel="stylesheet" href="js/reveal/reset.css">
    <link rel="stylesheet" href="js/reveal/reveal.css">
    <link rel="stylesheet" href="js/reveal/theme/black.css">
	<style>
		:root {
			--r-main-font-size: 75px;
		}
		.small {
			font-size: 50px;
		}
		section {
			padding-top: 1em;
		}
        @keyframes fadein {
            0% {
                opacity: 0;
                display: none;
            }
            100% {
                opacity: 1;
            }
        }
        .singular.visible {
            display: none;
        }
        .singular.visible.current-fragment {
            display: block;
            animation: fadein 1s cubic-bezier(0.6, -0.05, 0.9, 0.9) normal;
        }
        .cancel {
            position: fixed;
            bottom: 0px;
            left: 0px;
            padding: 15px;
            font-size: 2em;
            color: #ffffff;
            font-family: Source Sans Pro, Helvetica, sans-serif;
            z-index: 100;
        }
	</style>
	<script src="js/boss.js"></script>
	<script>
	</script>

    <!-- Theme used for syntax highlighted code -->
    <link rel="stylesheet" href="plugin/highlight/monokai.css">
</head>
	<body>
        <div id="cancel" class="cancel" onclick="window.location.replace('http://boss.local:8080/#labs')">üõë Cancel</div>
		<div class="reveal">
			<div id="menu" class="slides" style="font-size: .65em">
                <section id="secrets gen" data-autoslide="50">
                    <h3>Secret Generation</h3>
                    <p class="fragment" data-autoslide="5000">Security secrets are being generated</p>
                    <p class="fragment" data-autoslide="500">Secrets generated include:
                        <ul>
                            <li class="fragment" style="font-size: .5em" data-autoslide="250">Talos Certificate Authority</li>
                            <li class="fragment" style="font-size: .5em" data-autoslide="250">Machine Identity</li>
                            <li class="fragment" style="font-size: .5em" data-autoslide="4000">K8S Cluster Join Token</li>
                        </ul>
                    </p>
                    <p>&nbsp;</p>
                    <p class="fragment singular" data-autoslide="5000">They are usable only for this cluster</p>
                    <p class="fragment singular" data-autoslide="5000">They are valid only for a short period of time</p>
                    <p class="fragment singular" data-autoslide="5000">Labinator is slow, so it can take a while</p>
                    <p class="fragment singular" data-autoslide="5000">A cluster could need more than 70 keys</p>
                    <p class="fragment singular" data-autoslide="120000">The tokens are useless after 24 hours</p>
                    <p class="fragment singular" data-autoslide="99990000" style="color:red;">‚ò†Ô∏èIt's taking too long!‚ò†Ô∏è</p>
                </section>
                <section id="disk wipe" data-autoslide="50">
                    <h3>Wiping Disks</h3>
                    <p class="fragment" data-autoslide="5000">We are wiping the partition table</p>
                    <p class="fragment" data-autoslide="5000">You may have noticed that start already</p>
                    <p>&nbsp;</p>
                    <p class="fragment singular" data-autoslide="10000">Physical talos nodes write to the disks</p>
                    <p class="fragment singular" data-autoslide="5000">Secrets, state, volumes, etc are included</p>
                    <p class="fragment singular" data-autoslide="5000">Get rid of it - we're starting a new cluster</p>
                    <!-- 30s initialization complete -->
                    <p class="fragment singular" data-autoslide="5000">The existing files also mess up our lab</p>
                    <p class="fragment singular" data-autoslide="5000">Talos will try to use existing partitions</p>
                    <p class="fragment singular" data-autoslide="5000">No need to reinstall over and over again</p>
                    <p class="fragment singular" data-autoslide="5000">It also shortens the boot time</p>
                    <p class="fragment singular" data-autoslide="5000">(You probably also don't want to lose data)</p>
                    <p class="fragment singular" data-autoslide="10000">This makes a lot of sense in production</p>
                    <!-- 60s initialization complete -->
                    <p class="fragment singular" data-autoslide="5000">For Labinator, we start fresh every time</p>
                    <p class="fragment singular" data-autoslide="10000">Plus, it shows that we aren't faking it!</p>
                    <p class="fragment singular" data-autoslide="5000">The wipe is done with Debian Linux</p>
                    <p class="fragment singular" data-autoslide="5000">It is also the distro in our VM labs</p>
                    <p class="fragment singular" data-autoslide="5000">The OS image is about 300Mb in size</p>
                    <p class="fragment singular" data-autoslide="10000">It isn't much, but it still takes too long</p>
                    <p class="fragment singular" data-autoslide="5000">Debian is a great general purpose distro</p>
                    <p class="fragment singular" data-autoslide="5000">We could add lots of utilities if we wanted</p>
                    <p class="fragment singular" data-autoslide="10000">...but we don't need that</p>
                    <p class="fragment singular" data-autoslide="5000">This is a "live" distro of Debian</p>
                    <p class="fragment singular" data-autoslide="5000">It is self-contained, and made for this lab</p>
                    <p class="fragment singular" data-autoslide="5000">It doesn't get installed on the boxes</p>
                    <p class="fragment singular" data-autoslide="5000">Boss will be informed when it is done wiping</p>
                    <p class="fragment singular" data-autoslide="120000">It should be done pretty soon</p>
                    <p class="fragment singular" data-autoslide="99990000" style="color:red;">‚ò†Ô∏èIt's taking too long!‚ò†Ô∏è</p>
                </section>
                <section id="powerup">
                    <h3>Power Is On!</h3>
                    <p>The machines are starting to come up</p>
                </section>
                <section id="booting-hypervisors" data-autoslide="50">
                    <h3>Booting Hypervisors</h3>
                    <p class="fragment" data-autoslide="5000">To run the VMs, we are starting <span id="NumHypervisors">0</span> hypervisors</p>
                    <p class="fragment" data-autoslide="5000" style="font-size: .75em">(<span id="NumPhysicalPXEBoots">0</span> have started booting, and <span id="InitializedHypervisors">0</span> are up)</p>
                    <p class="fragment">&nbsp;</p>
                    <p class="fragment singular" data-autoslide="5000">Starting hypervisors can take some time</p>
                    <p class="fragment singular" data-autoslide="5000">They pull their disk image from Boss</p>
                    <p class="fragment singular" data-autoslide="5000">The OS image is only about 300Mb in size</p>
                    <p class="fragment singular" data-autoslide="5000">It can be slow because of the netboot process</p>
                    <!-- 30s initialization complete -->
                    <p class="fragment singular" data-autoslide="5000">Initial PXE boot should be about done now</p>
                    <p class="fragment singular" data-autoslide="5000">We then chainload with iPXE</p>
                    <p class="fragment singular" data-autoslide="5000">This is nice because iPXE is more flexible</p>
                    <p class="fragment singular" data-autoslide="5000">iPXE takes a bit of time to finish init</p>
                    <p class="fragment singular" data-autoslide="5000">There is probably a setting that can change</p>
                    <p class="fragment singular" data-autoslide="5000">Or maybe it's from lame Realtek NIC drivers</p>
                    <!-- 30s initialization complete -->
                    <p class="fragment singular" data-autoslide="5000">Bare metal config is fetched from network</p>
                    <p class="fragment singular" data-autoslide="5000">This makes the nodes very flexible</p>
                    <p class="fragment singular" data-autoslide="5000">No state is stored on the hypervisors</p>
                    <p class="fragment singular" data-autoslide="5000">In fact, the OS image is a "live" image</p>
                    <p class="fragment singular" data-autoslide="5000">Disks are wiped on boot, too</p>
                    <p class="fragment singular" data-autoslide="5000">They can be cycled at any time</p>
                    <p class="fragment singular" data-autoslide="5000">This flexibility is important</p>
                    <p class="fragment singular" data-autoslide="5000">A machine could be a hypervisor</p>
                    <p class="fragment singular" data-autoslide="5000">... or a baremetal Talos node!</p>
                    <p class="fragment singular" data-autoslide="5000">Note that the "live" image is not optimized</p>
                    <p class="fragment singular" data-autoslide="5000">Some unneeded services are included</p>
                    <p class="fragment singular" data-autoslide="5000">It's OK - this is just a lab</p>
                    <p class="fragment singular" data-autoslide="5000">The hypervisors are ready immediately at boot</p>
                    <p class="fragment singular" data-autoslide="5000">Talos VM disk images are pulled in advance</p>
                    <p class="fragment singular" data-autoslide="5000">Labwatch will start VMs on the hypervisors</p>
                    <p class="fragment singular" data-autoslide="120000">Hypervisors should be up soon</p>
                    <p class="fragment singular" data-autoslide="99990000" style="color:red;">‚ò†Ô∏èIt's taking too long!‚ò†Ô∏è</p>
                </section>
                <section id="booting-nodes" data-autoslide="50">
                    <h3>Booting Nodes</h3>
                    <p class="fragment" data-autoslide="5000"><span id="LabName" style="font-family: Courier New, monospace">Foo</span> lab needs <span id="NumNodes">0</span> Talos nodes</p>
                    <p class="fragment" data-autoslide="5000" style="font-size: .75em">(<span id="NumVirtualPXEBoots">0</span> have started PXE booting, and <span id="InitializedNodes">0</span> are up)</p>
                    <p class="fragment">&nbsp;</p>
                    <p class="fragment singular" data-autoslide="5000">Starting nodes can take some time</p>
                    <p class="fragment singular" data-autoslide="5000">They pull their disk image from Boss</p>
                    <p class="fragment singular" data-autoslide="5000">The OS image is only about 100Mb in size</p>
                    <p class="fragment singular" data-autoslide="5000">It can be slow because of the netboot process</p>
                    <!-- 30s initialization complete -->
                    <p class="fragment singular" data-autoslide="10000">The nodes are booted with PXE/iPXE</p>
                    <p class="fragment singular" data-autoslide="5000">iPXE takes a bit of time to finish init</p>
                    <p class="fragment singular" data-autoslide="5000">The BOOTP process is pretty quick</p>
                    <p class="fragment singular" data-autoslide="5000">For some reason, it still takes 30 seconds</p>
                    <p class="fragment singular" data-autoslide="5000">The nodes should be done with iPXE init now</p>
                    <!-- 30s initialization complete -->
                    <p class="fragment singular" data-autoslide="5000">Talos config is fetched from the network</p>
                    <p class="fragment singular" data-autoslide="5000">It will automatically install to the node</p>
                    <p class="fragment singular" data-autoslide="5000">The installation is minimal</p>
                    <p class="fragment singular" data-autoslide="5000">There's only enough Linux to start the kernel</p>
                    <p class="fragment singular" data-autoslide="5000">The install just makes Talos persistent</p>
                    <p class="fragment singular" data-autoslide="5000">Future boots could skip that step</p>                   
                    <p class="fragment singular" data-autoslide="5000">... but we are doing it the hard way!</p>
                    <p class="fragment singular" data-autoslide="5000">Each node performs minimal initialization</p>
                    <p class="fragment singular" data-autoslide="5000">It synchronizes time first</p>
                    <p class="fragment singular" data-autoslide="5000">And pulls container images for the cluster</p>
                    <p class="fragment singular" data-autoslide="5000">Images are only pulled for the install</p>
                    <p class="fragment singular" data-autoslide="5000">Installation triggers a restart</p>
                    <p class="fragment singular" data-autoslide="10000">After reboot, the node awaits bootstrapping</p>
                    <p class="fragment singular" data-autoslide="5000">One node needs to be bootstrapped first</p>
                    <p class="fragment singular" data-autoslide="5000">After first bootstrap, the cluster forms</p>
                    <p class="fragment singular" data-autoslide="120000">We will bootstrap soon now</p>
                    <p class="fragment singular" data-autoslide="99990000" style="color:red;">‚ò†Ô∏èIt's taking too long!‚ò†Ô∏è</p>
                </section>
                <section id="bootstrapping" data-autoslide="50">
                    <h3>Bootstrapping</h3>
                    <p class="fragment" data-autoslide="5000">Bootstrapping sets up the etcd cluster</p>
                    <p class="fragment" data-autoslide="5000">The K8S control plane coordinates via etcd</p>
                    <p>&nbsp;</p>
                    <p class="fragment singular" data-autoslide="5000">The bootstrap node starts cluster formation</p>
                    <p class="fragment singular" data-autoslide="5000">It serves as the first cluster leader</p>
                    <p class="fragment singular" data-autoslide="5000">Nodes join as followers to form the cluster</p>
                    <p class="fragment singular" data-autoslide="5000">The Raft algorithm is used to set future leaders</p>
                    <p class="fragment singular" data-autoslide="5000">The leader handles writes and replication</p>
                    <p class="fragment singular" data-autoslide="5000">All nodes support read operations</p>
                    <p class="fragment singular" data-autoslide="5000">The cluster settles with workers and CP nodes</p>
                    <p class="fragment singular" data-autoslide="120000">We are just about there</p>
                    <p class="fragment singular" data-autoslide="99990000" style="color:red;">‚ò†Ô∏èIt's taking too long!‚ò†Ô∏è</p>
                </section>
                <section id="finalizing" data-autoslide="50">
                    <h3>Finalizing</h3>
                    <p class="fragment" data-autoslide="5000">The Kubernetes cluster is up!</p>
                    <p class="fragment" data-autoslide="5000" style="font-size: .75em">(which is great, but we need more)</p>
                    <p class="fragment" data-autoslide="500">Let's deploy some additional workloads:
                        <ul>
                            <li class="fragment" style="font-size: .5em" data-autoslide="250">OpenTelemetry collector</li>
                            <li class="fragment" style="font-size: .5em" data-autoslide="250">prometheus-node-exporter</li>
                            <li class="fragment" style="font-size: .5em" data-autoslide="250">kube-state-metrics</li>
                            <li class="fragment" style="font-size: .5em" data-autoslide="4000">Prometheus</li>
                        </ul>
                    </p>
                    <p class="fragment singular" data-autoslide="10000">Most additional items provide observability</p>
                    <p class="fragment singular" data-autoslide="5000">It's vital since K8S has a lot going on</p>
                    <p class="fragment singular" data-autoslide="5000">Talos is also actively managing the cluster</p>
                    <p class="fragment singular" data-autoslide="5000">And we can't forget about etcd, too</p>
                    <p class="fragment singular" data-autoslide="10000">So we aggregate all the data together</p>
                    <p class="fragment singular" data-autoslide="5000">OTelCol reads the node logs</p>
                    <p class="fragment singular" data-autoslide="5000">This tells us how/what kubelet is doing</p>
                    <p class="fragment singular" data-autoslide="5000">It ships the logs to Boss's Loki instance</p>
                    <p class="fragment singular" data-autoslide="5000">Node exporter observes all nodes' health</p>
                    <p class="fragment singular" data-autoslide="5000">The data includes cpu/memory/network stats</p>
                    <p class="fragment singular" data-autoslide="5000">It is useful for ANY kind of Linux node</p>
                    <p class="fragment singular" data-autoslide="5000">Additional data includes i/o and procs</p>
                    <p class="fragment singular" data-autoslide="5000">Monitors can be turned on and off as needed</p>
                    <p class="fragment singular" data-autoslide="5000">Its metrics are gathered by Prometheus</p>
                    <p class="fragment singular" data-autoslide="10000">Prometheus itself is being added, too</p>
                    <p class="fragment singular" data-autoslide="5000">It's role is to gather from the inside</p>
                    <p class="fragment singular" data-autoslide="5000">All of the data is aggregated by Boss</p>
                    <p class="fragment singular" data-autoslide="5000">This means the cluster is ephemeral</p>
                    <p class="fragment singular" data-autoslide="5000">We lose nothing if Prometheus is redeployed</p>
                    <p class="fragment singular" data-autoslide="5000">kube-state-metrics is watching K8S health</p>
                    <p class="fragment singular" data-autoslide="5000">This tells us about node/pod health</p>
                    <p class="fragment singular" data-autoslide="5000">We also get memory and CPU metrics</p>
                    <p class="fragment singular" data-autoslide="5000">This is the K8S view rather than the node</p>
                    <p class="fragment singular" data-autoslide="10000">Having both lets us see scheduling pressure</p>
                    <p class="fragment singular" data-autoslide="120000">We're almost done deploying</p>
                    <p class="fragment singular" data-autoslide="99990000" style="color:red;">‚ò†Ô∏èIt's taking too long!‚ò†Ô∏è</p>
                </section>
                <section id="starting" data-autoslide="50">
                    <h3>Starting</h3>
                    <p class="fragment" data-autoslide="5000">Pods are starting</p>
                    <p class="fragment" data-autoslide="2000" style="font-size: .75em">(<span id="InitializedPods">0</span> of <span id="NumPods">0</span> pods are up)</p>
                    <p>&nbsp;</p>
                    <p class="fragment singular" data-autoslide="5000">Some have been starting since bootstrap</p>
                    <p class="fragment singular" data-autoslide="5000">kube-controller-manager is the control plane</p>
                    <p class="fragment singular" data-autoslide="5000">The CNI creates the overlay network</p>
                    <p class="fragment singular" data-autoslide="2000">It allows pods to communicate privately</p>
                    <p class="fragment singular" data-autoslide="5000">kube-proxy traverses underlay -> overlay</p>
                    <p class="fragment singular" data-autoslide="5000">coredns provides cluster DNS resolution</p>
                    <p class="fragment singular" data-autoslide="2000">It forwards non-cluster queries externally</p>
                    <p class="fragment singular" data-autoslide="120000">Almost there - not much more to do</p>
                    <p class="fragment singular" data-autoslide="99990000" style="color:red;">‚ò†Ô∏èIt's taking too long!‚ò†Ô∏è</p>
                </section>
                <section id="done" data-state="doneSlide">
                    <h3>Done!</h3>
                    <p class="fragment" data-autoslide="1000">We are all set!</p>
                    <p>Heading back to <a href="/#labs">landing</a></p>
                </section>
                <section id="failure" data-background-image="assets/fire.gif">
                    <h2 style="color:red;">‚ò†Ô∏èARGHHH!‚ò†Ô∏è</h2>
                    <p>&nbsp;</p>
                    <p>Something failed</p>
                    <p>We could not complete the <span id="CurrentStep">current</span> step</p>
                    <p>&nbsp;</p>
                    <p>Head back to the <a href="/#labs">main</a> page?</p>
                </section>
			</div>
		</div>

        <script>
            currentStep = "";
            var socket = new WebSocket('ws://localhost:8080/status');

            socket.onopen = () => {
                console.log('Connected to labwatch status server');
            };

            socket.onclose = () => {
                console.log('Connection to labwatch closed:', event.code, event.reason);
                setTimeout(function() {
                    socket = new WebSocket('ws://localhost:8080/status');
                }, 1000);
            };

            socket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data)
                    if (currentStep != data['initializer']['CurrentStep']) {
                        currentStep = data['initializer']['CurrentStep']
                        console.log("advancing to next step: ", currentStep)
                        Reveal.toggleAutoSlide(false)
                        gotoSlide(currentStep)
                        Reveal.toggleAutoSlide(true)
                    }

                    if (data['initializer']['Failed']) {
                        gotoSlide("failure")
                    }

                    for (const [k, v] of Object.entries(data['logs'])) {
                        const el = document.getElementById(k)
                        if ( el != null ) {
                            el.innerHTML = v
                        }
                    }

                    for (const [k, v] of Object.entries(data['initializer'])) {
                        const el = document.getElementById(k)
                        if ( el != null ) {
                            el.innerHTML = v
                        }
                    }
                } catch (error) {
                    console.log("Failed parsing JSON from status server:", error)
                }

            };

            socket.onclose = () => {
                console.log('Disconnected from labwatch status server');
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        </script>

		<script src="js/reveal/reveal.js"></script>
		<script src="js/reveal/plugin/markdown/markdown.js"></script>
		<script src="js/reveal/plugin/highlight/highlight.js"></script>
        <script src="js/reveal/plugin/tagteam/tagteam.js"></script>
		<script>
			Reveal.initialize({
				hash: true,
				progress: true,
				viewDistance: 100,

                controls: false,
                jumpToSlide: false,
                history: false,
                keyboard: false,
                overview: false,
                touch: false,
                mouseWheel: false,

				plugins: [ RevealMarkdown, RevealHighlight, Tagteam ]
			});

            Reveal.addEventListener('doneSlide', async function() {
				await navigateBottomWindow('https://boss.local:3000/grafana/d/k8s_views_global/kubernetes-views-global?kiosk=true&orgId=1&from=now-1h&to=now&timezone=browser&var-datasource=prometheus&var-cluster=&var-resolution=30s&refresh=30s');
                window.location.replace('http://boss.local:8080/index.html');
			});
		</script>
	</body>
</html>
