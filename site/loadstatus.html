<!DOCTYPE html>
<html>
<head>
    <title>Lab Status</title>
    <style>
        body {
            font-family: Source Sans Pro, Helvetica, sans-serif;
            background-color: #191919;
            color: #ffffff;
        }
        h1 h2 h3 h4 h5 {
            color: #ffffff;
        }
        td, th {
            border: 1px solid #686868;
            padding: 1px 5px 1px 5px;
        }
        table {
            border-collapse: collapse;
        }
        img.logo {
            position: fixed;
            top: 0px;
            right: 0px;
            padding: 15px;
            height: 128px;
            animation: fade 3s infinite alternate;
        }
        div.labnode {
            border: 1px solid #686868;
            margin: 10px;
            padding: 10px;
        }
        div.node {
            filter: brightness(50%);
        }
        div.virtual {
            background-color: #444444;
            margin: 5px;
            padding: 5px;
            border: 1px solid #888888;
        }
        [data-highlight-changes] span, span[data-highlight-changes] {
            position: relative;
        }
        [data-highlight-changes] span::before, span[data-highlight-changes]::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle, yellow 40%, transparent 100%);
            opacity: 0;
            transition: opacity .25s;
            pointer-events: none;
        }
        .updated-highlight::before {
            opacity: 1 !important;
        }
        span.name {
            font-weight: bold;
        }
        span.type {
            font-size: .7em;
        }
        span.number {
            text-align: center;
            vertical-align: middle;
            display: inline-block;
            padding: 3px;
            min-width: 1em;
        }
        span.ok {
            background-color: green;
            margin-left: 15px;
            border-radius: 30%;
        }
        span.nok {
            background-color: rgb(40, 63, 68);
            border-radius: 30%;
        }
        span.hits {
            background-color: #888888;
            border-radius: 30%;
        }
        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        .connection-indicator.connected {
            background-color: green;
            animation: fade .25s infinite alternate;
        }
        .connection-indicator.disconnected {
            background-color: red;
        }
        .connection-status {
            margin-right: 20px;
        }
        .container-status {
            margin-right: 20px;
        }
        .cluster-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            margin-top: 10px;
        }
        .cluster-nodes {
            flex: 1;
        }
        .filter-panel {
            margin-left: 20px;
            padding: 15px;
            border: 1px solid #686868;
            background-color: #2a2a2a;
            min-width: 150px;
        }
        .filter-panel h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #ffffff;
        }
        .filter-link {
            display: block;
            color: #ffffff;
            text-decoration: none;
            padding: 5px 0;
            cursor: pointer;
            user-select: none;
        }
        .filter-link:hover {
            color: #cccccc;
        }
        .filter-link.active {
            color: #00ff00;
            font-weight: bold;
        }
        .filter-link.inactive {
            color: #888888;
            text-decoration: line-through;
        }
        th {
            color: #bebebe;
            text-align: left;
            font-weight: normal;
            font-size: .8em;
        }
        @keyframes fade {
            0% {
                opacity: 0.6;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0.6;
            }
        }
    </style>
    <!-- https://unpkg.com/chart.js@2.8.0/dist/Chart.bundle.js -->
    <script src="/js/Chart.bundle.js"></script>
    <!-- https://unpkg.com/chartjs-gauge@0.3.0/dist/chartjs-gauge.js -->
    <script src="/js/chartjs-gauge.js"></script>
</head>
<body>
    <div style="display: flex; align-items: center; margin-bottom: 20px;">
        <h1 id="title" style="margin-right: 30px;">Status</h1>
        <div class="connection-status">
            <span class="connection-indicator disconnected" id="loadConnectionIndicator"></span>Load Info
        </div>
        <div class="connection-status">
            <span class="connection-indicator disconnected" id="statusConnectionIndicator"></span>Status
        </div>
        <div id="container-status" style="display: none;" data-highlight-changes="true">
            <div class="container-status">
                <span class="container-count" id="clientContainerCount">?</span> Clients
            </div>
            <div class="container-status">
                <span class="container-count" id="serverContainerCount">?</span> Servers
            </div>
        </div>
    </div>
    <img class="logo" src="/assets/logo-white.svg" />

    <div id="lab" style="display: none;">
        <table id="overview" data-highlight-changes="true">
            <tr>
                <th>Name</th>
                <th>CurrentStep</th>
                <th>Booting Physical</th>
                <th>Booting Virtual</th>
                <th>Hypervisors</th>
                <th>Nodes</th>
                <th>Pods</th>
            <tr>
                <td><span id="LabName"></span></td>
                <td><span id="CurrentStep">N/A</span></td>
                <td><span id="NumPhysicalPXEBoots">0</span></td>
                <td><span id="NumVirtualPXEBoots">0</span></td>
                <td><span id="InitializedHypervisors">0</span> / <span id="NumHypervisors">0</span></td>
                <td><span id="InitializedNodes">0</span> / <span id="NumNodes">0</span></td>
                <td><span id="InitializedPods">0</span> / <span id="NumPods">0</span></td>
            </tr>
        </table>

        <table id="messages" style="margin-top: 10px;">
            <tr>
                <th>Total</th>
                <th>Emergency</th>
                <th>Alert</th>
                <th>Critical</th>
                <th>Error</th>
                <th>Warn</th>
                <th>Notice</th>
                <th>Info</th>
                <th>Debug</th>
            </tr>
            <tr>
                <td><span id="NumMessages">0</span></td>
                <td><span id="NumEmergencyMessages">0</span></td>
                <td><span id="NumAlertMessages">0</span></td>
                <td><span id="NumCriticalMessages">0</span></td>
                <td><span id="NumErrorMessages">0</span></td>
                <td><span id="NumWarnMessages">0</span></td>
                <td><span id="NumNoticeMessages">0</span></td>
                <td><span id="NumInfoMessages">0</span></td>
                <td><span id="NumDebugMessages">0</span></td>
            </tr>
        </table>
    </div>

    <div id="load" style="display:none; flex-direction: row; align-items: center;">
        <div id="summary">
            <table data-highlight-changes="true">
                <tr>
                    <th colspan="2">Totals - Clients</th>
                    <th colspan="2">Totals - Servers</th>
                    <th colspan="2">Rates - Clients</th>
                    <th colspan="2">Rates - Servers</th>
                </tr>
                <tr>
                    <th>OK</th>
                    <th>Error</th>
                    <th>OK</th>
                    <th>Error</th>
                    <th>OK</th>
                    <th>Error</th>
                    <th>OK</th>
                    <th>Error</th>
                </tr>
                <tr>
                    <td><span id="TotalClientOk">0</span></td>
                    <td><span id="TotalClientNok">0</span></td>
                    <td><span id="TotalServerOk">0</span></td>
                    <td><span id="TotalServerNok">0</span></td>
                    <td><span id="ClientOkRate">0</span></td>
                    <td><span id="ClientNokRate">0</span></td>
                    <td><span id="ServerOkRate">0</span></td>
                    <td><span id="ServerNokRate">0</span></td>
                </tr>
            </table>
        </div>

        <div id="gauges">
            <div style="text-align: center;">
                <canvas id="serverOkGauge" width="300" height="125"></canvas>
            </div>
        </div>
    </div>

    <div class="cluster-container">
        <div class="cluster-nodes">
            <div id="cluster-top" style="display:flex; flex-direction: row; align-items: center;">
                <div class="labnode" id="node1">
                </div>
                <div class="labnode" id="node3">
                </div>
                <div class="labnode" id="node5">
                </div>
            </div>

            <div id="cluster-bottom" style="display:flex; flex-direction: row; align-items: center;">
                <div class="labnode" id="node2">
                </div>
                <div class="labnode" id="node4">
                </div>
                <div class="labnode" id="node6">
                </div>
            </div>
        </div>

        <div id="filter" class="filter-panel" style="display: none;">
            <h4>Pod Filters</h4>
            <a class="filter-link active" id="systemFilter" onclick="toggleFilter('system')">System</a>
            <a class="filter-link active" id="monitoringFilter" onclick="toggleFilter('monitoring')">Monitoring</a>
            <a class="filter-link active" id="clientsFilter" onclick="toggleFilter('clients')">Clients</a>
            <a class="filter-link active" id="serversFilter" onclick="toggleFilter('servers')">Servers</a>
        </div>
    </div>


    <script>
        // Hold some globals for continued updates
        var lastStatus = {}
        var statusContainers = {}
        var labNodes = {}
        var lastNodeState = {}
        
        // Cache elements that get updated frequently via WebSocket messages
        const statusElements = {
            // Load status elements
            'TotalClientOk': document.getElementById('TotalClientOk'),
            'TotalClientNok': document.getElementById('TotalClientNok'),
            'TotalServerOk': document.getElementById('TotalServerOk'),
            'TotalServerNok': document.getElementById('TotalServerNok'),
            'ClientOkRate': document.getElementById('ClientOkRate'),
            'ClientNokRate': document.getElementById('ClientNokRate'),
            'ServerOkRate': document.getElementById('ServerOkRate'),
            'ServerNokRate': document.getElementById('ServerNokRate'),
            
            // Initializer status elements
            'LabName': document.getElementById('LabName'),
            'CurrentStep': document.getElementById('CurrentStep'),
            'NumPhysicalPXEBoots': document.getElementById('NumPhysicalPXEBoots'),
            'NumVirtualPXEBoots': document.getElementById('NumVirtualPXEBoots'),
            'InitializedHypervisors': document.getElementById('InitializedHypervisors'),
            'NumHypervisors': document.getElementById('NumHypervisors'),
            'InitializedNodes': document.getElementById('InitializedNodes'),
            'NumNodes': document.getElementById('NumNodes'),
            'InitializedPods': document.getElementById('InitializedPods'),
            'NumPods': document.getElementById('NumPods'),
            
            // Message counters
            'NumMessages': document.getElementById('NumMessages'),
            'NumEmergencyMessages': document.getElementById('NumEmergencyMessages'),
            'NumAlertMessages': document.getElementById('NumAlertMessages'),
            'NumCriticalMessages': document.getElementById('NumCriticalMessages'),
            'NumErrorMessages': document.getElementById('NumErrorMessages'),
            'NumWarnMessages': document.getElementById('NumWarnMessages'),
            'NumNoticeMessages': document.getElementById('NumNoticeMessages'),
            'NumInfoMessages': document.getElementById('NumInfoMessages'),
            'NumDebugMessages': document.getElementById('NumDebugMessages')
        }
        
        // Cache frequently accessed DOM elements
        const domElements = {
            title: document.getElementById('title'),
            lab: document.getElementById('lab'),
            load: document.getElementById('load'),
            filter: document.getElementById('filter'),
            containerStatus: document.getElementById('container-status'),
            clientContainerCount: document.getElementById('clientContainerCount'),
            serverContainerCount: document.getElementById('serverContainerCount'),
            loadConnectionIndicator: document.getElementById('loadConnectionIndicator'),
            statusConnectionIndicator: document.getElementById('statusConnectionIndicator')
        }
        
        // Filter globals and cached DOM elements
        var filters = {
            'system': false,
            'monitoring': false,
            'clients': true,
            'servers': true,
        }
        
        // Cache filter DOM elements
        const filterElements = {
            'system': document.getElementById('systemFilter'),
            'monitoring': document.getElementById('monitoringFilter'),
            'clients': document.getElementById('clientsFilter'),
            'servers': document.getElementById('serversFilter')
        }

        function updateSpanValue(target, newValue) {
            const el = (typeof target === 'string') ? statusElements[target] || document.getElementById(target) : target
            if (el && el.innerHTML !== String(newValue)) {
                el.innerHTML = newValue
                if (el.hasAttribute('data-highlight-changes') || el.closest('[data-highlight-changes]')) {
                    el.classList.add('updated-highlight')
                    setTimeout(() => {
                        el.classList.remove('updated-highlight')
                    }, 250)
                }
            }
        }
        
        function formatNumber(num) {
            const absNum = Math.abs(num);
            const sign = num < 0 ? '-' : '';
            
            if (absNum >= 1e12) {
                return sign + (absNum / 1e12).toFixed(2) + 't';
            } else if (absNum >= 1e9) {
                return sign + (absNum / 1e9).toFixed(2) + 'b';
            } else if (absNum >= 1e6) {
                return sign + (absNum / 1e6).toFixed(2) + 'm';
            } else if (absNum >= 1e3) {
                return sign + (absNum / 1e3).toFixed(2) + 'k';
            }
            return sign + absNum.toString();
        }

        function updateFilterVisualState(filterType = null) {
            if (filterType) {
                filterElements[filterType].className = 'filter-link ' + (filters[filterType] ? 'active' : 'inactive');
            } else {
                Object.entries(filters).forEach(([type, isActive]) => {
                    filterElements[type].className = 'filter-link ' + (isActive ? 'active' : 'inactive');
                });
            }
        }

        function toggleFilter(filterType) {
            filters[filterType] = !filters[filterType];
            updateFilterVisualState(filterType);
            updateNodeContainerCounts(statusContainers);
        }

        // Initialize filter states
        updateFilterVisualState()

        function updateNodeHitCounts(counts) {
            var update = {}

            // Nodes we saw after reading config
            for (const [nodeName, v] of Object.entries(labNodes)) {
               update[nodeName] = 0
            }

            // Counts from the loadinfo server
            for (const [containerName, hitCounts] of Object.entries(counts)) {
                // Married up to the information from statusContainers
                containerInfo = statusContainers[containerName]
                if (containerInfo != null) {
                    nodeName = containerInfo['Node']
                    if (update[nodeName] != null) {
                        update[nodeName] += hitCounts.OK
                    }
                }
            }

            for (const [nodeName, hits] of Object.entries(update)) {
                if (labNodes[nodeName] != null) {
                    labNodes[nodeName].hits.innerHTML = formatNumber(hits)
                }
            }
        }

        function updateNodeStatus(ports) {
            if (ports == null ) return

            for (const [combo, up] of Object.entries(ports)) {
                if (lastNodeState[combo] != up) {
                    const [ip, port] = combo.split(':')
                    console.log('node %s changed state %s', ip, up)
                    el = ip2NodeElement[ip]
                    if (el != null) {
                        el.style.filter = up ? 'brightness(100%)' : 'brightness(50%)'
                    }
                }
            }
            lastNodeState = ports
        }

        function updateNodeContainerCounts(containers) {
            if (containers == null ) {
                for (const [nodeName, v] of Object.entries(labNodes)) {
                    labNodes[nodeName].ok.innerHTML = 0
                    labNodes[nodeName].nok.innerHTML = 0
                }
                return
            }

            statusContainers = containers
            var clientCount = 0
            var serverCount = 0
            var update = {}

            // Nodes we saw after reading config
            for (const [nodeName, v] of Object.entries(labNodes)) {
               update[nodeName] = {ok: 0, nok: 0}
            }

            for (const [podName, podInfo] of Object.entries(containers)) {
                nodeName = podInfo['Node']

                switch(podInfo['Namespace']) {
                case 'default':
                    if (podName.startsWith('counterclient')) {
                        clientCount += 1
                        if (!filters['clients']) { continue }
                    } else if (podName.startsWith('counterserver')) {
                        serverCount += 1
                        if (!filters['servers']) { continue }
                    }
                    break
                case 'kube-prometheus-stack':
                    if (!filters['monitoring']) { continue }
                    break
                case 'kube-system':
                    if (!filters['system']) { continue }
                    break
                default:
                    if (!filters['other']) { continue }
                    break
                }
                

                if (update[nodeName] != null) {
                    if (podInfo['Status'] == 'Running') {
                        update[nodeName].ok += 1
                    } else {
                        update[nodeName].nok += 1
                    }
                }
            }

            for (const [nodeName, counts] of Object.entries(update)) {
                if (labNodes[nodeName] != null) {
                    updateSpanValue(labNodes[nodeName].ok, counts.ok)
                    updateSpanValue(labNodes[nodeName].nok, counts.nok)
                }
            }

            updateSpanValue(document.getElementById('clientContainerCount'), clientCount)
            updateSpanValue(document.getElementById('serverContainerCount'), serverCount)
        }
    </script>

    <script>
        // Chart.js Gauge configuration using chartjs-gauge
        const gaugeConfig = {
            minValue: 0,
            maxValue: 4000,
            redZone: 500,
            yellowZone: 1250
        };

        function createGauge(ctx, label) {
            return new Chart(ctx, {
                type: 'gauge',
                data: {
                    datasets: [{
                        value: 0,
                        minValue: gaugeConfig.minValue,
                        data: [
                            gaugeConfig.redZone,
                            gaugeConfig.yellowZone,
                            gaugeConfig.maxValue
                        ],
                        backgroundColor: ['red', 'yellow', 'green'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: false,
                    title: {
                        display: true,
                        text: label
                    },
                    layout: {
                        padding: {
                            bottom: 30
                        }
                    },
                    needle: {
                        // Needle circle radius as the percentage of the chart area width
                        radiusPercentage: 2,
                        // Needle width as the percentage of the chart area width
                        widthPercentage: 3.2,
                        // Needle length as the percentage of the interval between inner radius (0%) and outer radius (100%) of the arc
                        lengthPercentage: 80,
                        // The color of the needle
                        color: 'rgba(0, 0, 0, 1)'
                    },
                    valueLabel: {
                        formatter: Math.round
                    }
                }
            });
        }

        const serverOkGauge = createGauge(document.getElementById('serverOkGauge').getContext('2d'), 'Server OK Rate');

        function updateGauges(serverOkRate, serverNokRate) {
            const clampedRate = Math.min(serverOkRate, gaugeConfig.maxValue);
            
            serverOkGauge.data.datasets[0].value = clampedRate;
            serverOkGauge.options.valueLabel.formatter = function() {
                return Math.round(serverOkRate);
            };

            serverOkGauge.update();
        }
    </script>

    <script>
        let loadSocket;

        function connectLoadSocket() {
            loadSocket = new WebSocket('ws://localhost:8080/loadinfo');

            loadSocket.onopen = () => {
                console.log('Connected to labwatch loadinfo server');
                domElements.loadConnectionIndicator.className = 'connection-indicator connected';
            };

            loadSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data)
                    for (const [k, v] of Object.entries(data)) {
                        const el = statusElements[k]
                        if (el) {
                            el.innerHTML = !isNaN(v) ? formatNumber(Number(v)) : v
                        }
                    }

                    updateGauges(data['ServerOkRate'], data['ServerNokRate'])
                    updateNodeHitCounts(data['Servers'])
                } catch (error) {
                    console.log("Failed parsing JSON from loadinfo server:", error)
                }
            };

            loadSocket.onclose = () => {
                console.log('Disconnected from labwatch loadinfo server - reconnecting in 5 seconds...');
                domElements.loadConnectionIndicator.className = 'connection-indicator disconnected';
                setTimeout(connectLoadSocket, 5000);
            };

            loadSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                domElements.loadConnectionIndicator.className = 'connection-indicator disconnected';
                loadSocket.close();
            };
        }

        // Initial connection
        connectLoadSocket();
    </script>

    <script>
        fetch('/scenarios?last=true')
        .then(response => response.json())
        .then(cfg => {
            console.log("config: %o", cfg)

            ip2HypervisorName = {}
            ip2NodeElement = {}

            const hostTypes = [ 'physical', 'hypervisor', 'virtual' ]
            hostTypes.forEach(type => {
                for (let key in cfg['nodes']) {
                    if (!cfg['nodes'].hasOwnProperty(key)) {
                        continue
                    }
                    node = cfg['nodes'][key]

                    if (node['type'] !== type) {
                        continue
                    }
                    
                    var parent
                    var hasContainers = false
                    switch(type) {
                    case 'physical':
                        parent = document.getElementById(node['nodename'])
                        hasContainers = true
                        break;
                    case 'hypervisor':
                        ip2HypervisorName[node['ip']] = node['name']
                        parent = document.getElementById(node['nodename'])
                        break;
                    case 'virtual':
                        hypervisorName = ip2HypervisorName[node['hypervisor']['ip']]
                        parent = document.getElementById(hypervisorName)
                        hasContainers = true
                        break;
                    }

                    newDiv = document.createElement('div')
                    newDiv.setAttribute('id', node['name'])
                    newDiv.classList.add(type, 'node')
                    ip2NodeElement[node['ip']] = newDiv

                    newSpan = document.createElement('span')
                    newSpan.className = 'nodename'
                    newSpan.innerHTML = node['name']
                    newDiv.appendChild(newSpan)

                    /*
                    newSpan = document.createElement('span')
                    newSpan.className = 'type'
                    newSpan.innerHTML = " (" + type + ")"
                    newDiv.appendChild(newSpan)
                    */

                    if (hasContainers) {
                        okSpan = document.createElement('span')
                        okSpan.setAttribute('id', node['name'] + "-ok")
                        okSpan.setAttribute('data-highlight-changes', 'true')
                        okSpan.className = 'number ok'
                        okSpan.innerHTML = 0
                        newDiv.appendChild(okSpan)

                        nokSpan = document.createElement('span')
                        nokSpan.setAttribute('id', node['name'] + "-nok")
                        okSpan.setAttribute('data-highlight-changes', 'true')
                        nokSpan.className = 'number nok'
                        nokSpan.innerHTML = 0
                        newDiv.appendChild(nokSpan)

                        hitSpan = document.createElement('span')
                        hitSpan.setAttribute('id', node['name'] + "-hits")
                        hitSpan.className = 'number hits'
                        hitSpan.innerHTML = 0
                        newDiv.appendChild(hitSpan)

                        labNodes[node['name']] = {
                            'ok': okSpan,
                            'nok': nokSpan,
                            'hits': hitSpan,
                        }
                    }

                    parent.appendChild(newDiv)
                }            
            });
        })
        .catch(error => {
            console.error('Error fetching scenario:', error);
        });
    </script>

    <script>
        let statusSocket;

        function connectStatusSocket() {
            statusSocket = new WebSocket('ws://localhost:8080/status');

            statusSocket.onopen = () => {
                console.log('Connected to labwatch status server');
                domElements.statusConnectionIndicator.className = 'connection-indicator connected';
            };

            statusSocket.onmessage = (event) => {
                try {
                    const status = JSON.parse(event.data)

                    // Update all status values
                    for (const [k, v] of Object.entries(status['initializer'])) {
                        updateSpanValue(k, v)
                    }
                    for (const [k, v] of Object.entries(status['logs'])) {
                        updateSpanValue(k, v)
                    }
                    for (const [k, v] of Object.entries(status)) {
                        const el = document.getElementById(k)
                        if ( el != null ) {
                            updateSpanValue(el, v)
                        }
                    }

                    if (lastStatus['initializer'] == null || lastStatus['initializer']['CurrentStep'] != status['initializer']['CurrentStep']) {
                        // Figure out what should be shown
                        switch(status['initializer']['CurrentStep']) {
                            case 'starting':
                                document.getElementById('title').innerHTML = 'Load Status'
                                document.getElementById('lab').style.display = 'none'
                                document.getElementById('load').style.display = 'flex'
                                document.getElementById('filter').style.display = 'block'
                                document.getElementById('container-status').style.display = 'flex'
                                // Set all filters to true
                                Object.keys(filters).forEach(key => {
                                    filters[key] = true;
                                });
                                break;
                            case '':
                            case 'done':
                                document.getElementById('title').innerHTML = 'Load Status'
                                document.getElementById('lab').style.display = 'none'
                                document.getElementById('load').style.display = 'flex'
                                document.getElementById('filter').style.display = 'block'
                                document.getElementById('container-status').style.display = 'flex'
                                filters['system'] = false
                                filters['monitoring'] = false
                                filters['clients'] = true
                                filters['servers'] = true
                                break;
                            default:
                                document.getElementById('title').innerHTML = 'Lab Status'
                                document.getElementById('lab').style.display = 'block'
                                document.getElementById('load').style.display = 'none'
                                document.getElementById('filter').style.display = 'none'
                                document.getElementById('container-status').style.display = 'none'
                                filters['system'] = true
                                filters['monitoring'] = true
                                filters['clients'] = true
                                filters['servers'] = true
                                break;
                        }
                        updateFilterVisualState()
                    }

                    lastStatus = status
                    updateNodeStatus(status['ports'])
                    updateNodeContainerCounts(status['kubernetes'])
                } catch (error) {
                    console.log("Failed parsing JSON from status server:", error)
                }
            };

            statusSocket.onclose = () => {
                console.log('Disconnected from labwatch status server - reconnecting in 5 seconds...');
                document.getElementById('statusConnectionIndicator').className = 'connection-indicator disconnected';
                setTimeout(connectStatusSocket, 5000);
            };

            statusSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('statusConnectionIndicator').className = 'connection-indicator disconnected';
                statusSocket.close();
            };
        }

        // Initial connection
        connectStatusSocket();
    </script>
</body>
</html>