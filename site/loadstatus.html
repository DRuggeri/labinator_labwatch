<!DOCTYPE html>
<html>
<head>
    <title>Lab Status</title>
    <style>
        body {
            font-family: Source Sans Pro, Helvetica, sans-serif;
            background-color: #191919;
            color: #ffffff;
        }
        h1 h2 h3 h4 h5 {
            color: #ffffff;
        }
        td, th {
            border: 1px solid #686868;
            padding: 1px 5px 1px 5px;
        }
        table {
            border-collapse: collapse;
        }
        img.logo {
            position: fixed;
            top: 0px;
            right: 0px;
            padding: 15px;
            height: 128px;
        }
        div.labnode {
            border: 1px solid #686868;
            margin: 10px;
            padding: 10px;
        }
        div.virtual {
            background-color: #444444;
            margin: 5px;
            padding: 5px;
            border: 1px solid #888888;
        }
        span.name {
            font-weight: bold;
        }
        span.type {
            font-size: .7em;
        }
        span.number {
            text-align: center;
            vertical-align: middle;
            display: inline-block;
            padding: 3px;
            min-width: 1em;
        }
        span.ok {
            background-color: green;
        }
        span.nok {
            background-color: rgb(40, 63, 68);
        }
        span.hits {
            background-color: #888888;
        }
        .connection-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
        }
        .connection-indicator.connected {
            background-color: green;
        }
        .connection-indicator.disconnected {
            background-color: red;
        }
        .connection-status {
            margin-right: 20px;
        }
        .container-status {
            margin-right: 20px;
        }
        .cluster-container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
        }
        .cluster-nodes {
            flex: 1;
        }
        .filter-panel {
            margin-left: 20px;
            padding: 15px;
            border: 1px solid #686868;
            background-color: #2a2a2a;
            min-width: 150px;
        }
        .filter-panel h4 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #ffffff;
        }
        .filter-link {
            display: block;
            color: #ffffff;
            text-decoration: none;
            padding: 5px 0;
            cursor: pointer;
            user-select: none;
        }
        .filter-link:hover {
            color: #cccccc;
        }
        .filter-link.active {
            color: #00ff00;
            font-weight: bold;
        }
        .filter-link.inactive {
            color: #888888;
            text-decoration: line-through;
        }
    </style>
    <!-- https://unpkg.com/chart.js@2.8.0/dist/Chart.bundle.js -->
    <script src="/js/Chart.bundle.js"></script>
    <!-- https://unpkg.com/chartjs-gauge@0.3.0/dist/chartjs-gauge.js -->
    <script src="/js/chartjs-gauge.js"></script>
</head>
<body>
    <div style="display: flex; align-items: center; margin-bottom: 20px;">
        <h1 style="margin-right: 30px;">Load Status</h1>
        <div class="connection-status">
            <span class="connection-indicator disconnected" id="loadConnectionIndicator"></span>Load Info
        </div>
        <div class="connection-status">
            <span class="connection-indicator disconnected" id="statusConnectionIndicator"></span>Status
        </div>
        <div class="container-status">
            <span class="container-count" id="clientContainerCount">?</span> Clients
        </div>
        <div class="container-status">
            <span class="container-count" id="serverContainerCount">?</span> Servers
        </div>
    </div>
    <img class="logo" src="assets/logo-white.svg" />

    <div id="overview" style="display:flex; flex-direction: row; align-items: center;">
        <div id="summary">
            <table>
                <tr>
                    <th colspan="2">Totals - Clients</th>
                    <th colspan="2">Totals - Servers</th>
                    <th colspan="2">Rates - Clients</th>
                    <th colspan="2">Rates - Servers</th>
                </tr>
                <tr>
                    <th>OK</th>
                    <th>Error</th>
                    <th>OK</th>
                    <th>Error</th>
                    <th>OK</th>
                    <th>Error</th>
                    <th>OK</th>
                    <th>Error</th>
                </tr>
                <tr>
                    <td><span id="TotalClientOk">0</span></td>
                    <td><span id="TotalClientNok">0</span></td>
                    <td><span id="TotalServerOk">0</span></td>
                    <td><span id="TotalServerNok">0</span></td>
                    <td><span id="ClientOkRate">0</span></td>
                    <td><span id="ClientNokRate">0</span></td>
                    <td><span id="ServerOkRate">0</span></td>
                    <td><span id="ServerNokRate">0</span></td>
                </tr>
            </table>
        </div>

        <div id="gauges">
            <div style="text-align: center;">
                <canvas id="serverOkGauge" width="300" height="125"></canvas>
            </div>
        </div>
    </div>

    <div class="cluster-container">
        <div class="cluster-nodes">
            <div id="cluster-top" style="display:flex; flex-direction: row; align-items: center;">
                <div class="labnode" id="node1">
                </div>
                <div class="labnode" id="node3">
                </div>
                <div class="labnode" id="node5">
                </div>
            </div>

            <div id="cluster-bottom" style="display:flex; flex-direction: row; align-items: center;">
                <div class="labnode" id="node2">
                </div>
                <div class="labnode" id="node4">
                </div>
                <div class="labnode" id="node6">
                </div>
            </div>
        </div>

        <div class="filter-panel">
            <h4>Pod Filters</h4>
            <a class="filter-link active" id="systemFilter" onclick="toggleFilter('system')">System</a>
            <a class="filter-link active" id="monitoringFilter" onclick="toggleFilter('monitoring')">Monitoring</a>
            <a class="filter-link active" id="clientsFilter" onclick="toggleFilter('clients')">Clients</a>
            <a class="filter-link active" id="serversFilter" onclick="toggleFilter('servers')">Servers</a>
        </div>
    </div>


    <script>
        // Hold some globals for continued updates
        var statusContainers = {}
        var labNodes = {}
        
        // Filter globals
        var filters = {
            'system': false,
            'monitoring': false,
            'clients': true,
            'servers': true,
        }
        
        function toggleFilter(filterType) {
            const filterElement = document.getElementById(filterType + 'Filter');

            filters[filterType] = !filters[filterType]
            updateFilterVisualState()
            updateNodeContainerCounts(statusContainers)
        }

        function updateFilterVisualState() {
            for (const [filterType, isActive] of Object.entries(filters)) {
                const filterElement = document.getElementById(filterType + 'Filter');
                if (isActive) {
                    filterElement.className = 'filter-link active';
                } else {
                    filterElement.className = 'filter-link inactive';
                }
            }
        }
        updateFilterVisualState()

        function updateNodeHitCounts(counts) {
            var update = {}

            // Nodes we saw after reading config
            for (const [nodeName, v] of Object.entries(labNodes)) {
               update[nodeName] = 0
            }

            // Counts from the loadinfo server
            for (const [containerName, hitCounts] of Object.entries(counts)) {
                // Married up to the information from statusContainers
                containerInfo = statusContainers[containerName]
                if (containerInfo != null) {
                    nodeName = containerInfo['Node']
                    if (update[nodeName] != null) {
                        update[nodeName] += hitCounts.OK
                    }
                }
            }

            for (const [nodeName, hits] of Object.entries(update)) {
                if (labNodes[nodeName] != null) {
                    labNodes[nodeName].hits.innerHTML = hits
                }
            }
        }

        function updateNodeContainerCounts(containers) {
            statusContainers = containers
            var clientCount = 0
            var serverCount = 0
            var update = {}

            // Nodes we saw after reading config
            for (const [nodeName, v] of Object.entries(labNodes)) {
               update[nodeName] = {ok: 0, nok: 0}
            }

            for (const [podName, podInfo] of Object.entries(containers)) {
                nodeName = podInfo['Node']

                switch(podInfo['Namespace']) {
                case 'default':
                    if (podName.startsWith('counterclient')) {
                        clientCount += 1
                        if (!filters['clients']) { continue }
                    } else if (podName.startsWith('counterserver')) {
                        serverCount += 1
                        if (!filters['servers']) { continue }
                    }
                    break
                case 'kube-prometheus-stack':
                    if (!filters['monitoring']) { continue }
                    break
                case 'kube-system':
                    if (!filters['system']) { continue }
                    break
                default:
                    if (!filters['other']) { continue }
                    break
                }
                

                if (update[nodeName] != null) {
                    if (podInfo['Status'] == 'Running') {
                        update[nodeName].ok += 1
                    } else {
                        update[nodeName].nok += 1
                    }
                }
            }

            for (const [nodeName, counts] of Object.entries(update)) {
                if (labNodes[nodeName] != null) {
                    labNodes[nodeName].ok.innerHTML = counts.ok
                    labNodes[nodeName].nok.innerHTML = counts.nok
                }
            }

            document.getElementById('clientContainerCount').innerHTML = clientCount
            document.getElementById('serverContainerCount').innerHTML = serverCount
        }
    </script>

    <script>
        // Chart.js Gauge configuration using chartjs-gauge
        const gaugeConfig = {
            minValue: 0,
            maxValue: 4000,
            redZone: 500,
            yellowZone: 1250
        };

        function createGauge(ctx, label) {
            return new Chart(ctx, {
                type: 'gauge',
                data: {
                    datasets: [{
                        value: 0,
                        minValue: gaugeConfig.minValue,
                        data: [
                            gaugeConfig.redZone,
                            gaugeConfig.yellowZone,
                            gaugeConfig.maxValue
                        ],
                        backgroundColor: ['red', 'yellow', 'green'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    title: {
                        display: true,
                        text: label
                    },
                    layout: {
                        padding: {
                            bottom: 30
                        }
                    },
                    needle: {
                        // Needle circle radius as the percentage of the chart area width
                        radiusPercentage: 2,
                        // Needle width as the percentage of the chart area width
                        widthPercentage: 3.2,
                        // Needle length as the percentage of the interval between inner radius (0%) and outer radius (100%) of the arc
                        lengthPercentage: 80,
                        // The color of the needle
                        color: 'rgba(0, 0, 0, 1)'
                    },
                    valueLabel: {
                        formatter: Math.round
                    }
                }
            });
        }

        const serverOkGauge = createGauge(document.getElementById('serverOkGauge').getContext('2d'), 'Server OK Rate');

        function updateGauges(serverOkRate, serverNokRate) {
            serverOkGauge.data.datasets[0].value = serverOkRate;
            serverOkGauge.update();
        }
    </script>

    <script>
        let loadSocket;

        function connectLoadSocket() {
            loadSocket = new WebSocket('ws://localhost:8080/loadinfo');

            loadSocket.onopen = () => {
                console.log('Connected to labwatch loadinfo server');
                document.getElementById('loadConnectionIndicator').className = 'connection-indicator connected';
            };

            loadSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data)

                    for (const [k, v] of Object.entries(data)) {
                        const el = document.getElementById(k)
                        if ( el != null ) {
                            el.innerHTML = v
                        }
                    }

                    updateGauges(data['ServerOkRate'], data['ServerNokRate'])
                    updateNodeHitCounts(data['Servers'])
                } catch (error) {
                    console.log("Failed parsing JSON from status server:", error)
                }
            };

            loadSocket.onclose = () => {
                console.log('Disconnected from labwatch loadinfo server - reconnecting in 5 seconds...');
                document.getElementById('loadConnectionIndicator').className = 'connection-indicator disconnected';
                setTimeout(connectLoadSocket, 5000);
            };

            loadSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('loadConnectionIndicator').className = 'connection-indicator disconnected';
                loadSocket.close();
            };
        }

        // Initial connection
        connectLoadSocket();
    </script>

    <script>
        fetch('/scenarios?last=true')
        .then(response => response.json())
        .then(cfg => {
            console.log("config: %o", cfg)

            ip2HypervisorName = {}

            const hostTypes = [ 'physical', 'hypervisor', 'virtual' ]
            hostTypes.forEach(type => {
                for (let key in cfg['nodes']) {
                    if (!cfg['nodes'].hasOwnProperty(key)) {
                        continue
                    }
                    node = cfg['nodes'][key]

                    if (node['type'] !== type) {
                        continue
                    }
                    
                    var parent
                    var hasContainers = false
                    switch(type) {
                    case 'physical':
                        parent = document.getElementById(node['nodename'])
                        hasContainers = true
                        break;
                    case 'hypervisor':
                        ip2HypervisorName[node['ip']] = node['name']
                        parent = document.getElementById(node['nodename'])
                        break;
                    case 'virtual':
                        hypervisorName = ip2HypervisorName[node['hypervisor']['ip']]
                        parent = document.getElementById(hypervisorName)
                        hasContainers = true
                        break;
                    }

                    newDiv = document.createElement('div')
                    newDiv.setAttribute('id', node['name'])
                    newDiv.className = type

                    newSpan = document.createElement('span')
                    newSpan.className = 'nodename'
                    newSpan.innerHTML = node['name']
                    newDiv.appendChild(newSpan)

                    /*
                    newSpan = document.createElement('span')
                    newSpan.className = 'type'
                    newSpan.innerHTML = " (" + type + ")"
                    newDiv.appendChild(newSpan)
                    */

                    if (hasContainers) {
                        newSpan = document.createElement('span')
                        newSpan.innerHTML = " - "
                        newDiv.appendChild(newSpan)

                        okSpan = document.createElement('span')
                        okSpan.setAttribute('id', node['name'] + "-ok")
                        okSpan.className = 'number ok'
                        okSpan.innerHTML = 0
                        newDiv.appendChild(okSpan)

                        nokSpan = document.createElement('span')
                        nokSpan.setAttribute('id', node['name'] + "-nok")
                        nokSpan.className = 'number nok'
                        nokSpan.innerHTML = 0
                        newDiv.appendChild(nokSpan)

                        hitSpan = document.createElement('span')
                        hitSpan.setAttribute('id', node['name'] + "-hits")
                        hitSpan.className = 'number hits'
                        hitSpan.innerHTML = 0
                        newDiv.appendChild(hitSpan)

                        labNodes[node['name']] = {
                            'ok': okSpan,
                            'nok': nokSpan,
                            'hits': hitSpan,
                        }
                    }

                    parent.appendChild(newDiv)
                }            
            });
        })
        .catch(error => {
            console.error('Error fetching scenario:', error);
        });
    </script>

    <script>
        let statusSocket;

        function connectStatusSocket() {
            statusSocket = new WebSocket('ws://localhost:8080/status');

            statusSocket.onopen = () => {
                console.log('Connected to labwatch status server');
                document.getElementById('statusConnectionIndicator').className = 'connection-indicator connected';
            };

            statusSocket.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data)

                    for (const [k, v] of Object.entries(data)) {
                        const el = document.getElementById(k)
                        if ( el != null ) {
                            el.innerHTML = v
                        }
                    }

                    updateNodeContainerCounts(data['kubernetes'])
                } catch (error) {
                    console.log("Failed parsing JSON from status server:", error)
                }
            };

            statusSocket.onclose = () => {
                console.log('Disconnected from labwatch status server - reconnecting in 5 seconds...');
                document.getElementById('statusConnectionIndicator').className = 'connection-indicator disconnected';
                setTimeout(connectStatusSocket, 5000);
            };

            statusSocket.onerror = (error) => {
                console.error('WebSocket error:', error);
                document.getElementById('statusConnectionIndicator').className = 'connection-indicator disconnected';
                statusSocket.close();
            };
        }

        // Initial connection
        connectStatusSocket();
    </script>
</body>
</html>